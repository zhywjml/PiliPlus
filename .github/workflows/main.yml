name: Build Windows ARM64 (Native)

on:
  workflow_dispatch: # 允许手动点击按钮触发
  push:
    branches: [ "master", "main" ]

jobs:
  build:
    name: Build on Windows ARM64
    # 关键点：直接使用 ARM64 的 Runner，只有公共仓库(Public Repo)免费可用
    runs-on: windows-11-arm

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          # 通常 action 会自动检测架构，但显式指定更稳妥
          architecture: arm64 

      - name: Install Dependencies
        run: flutter pub get

      - name: Build Windows Release
        # 因为是在原生 ARM64 机器上跑，直接 build 就会生成 ARM64 程序
        run: flutter build windows --release

      - name: Organize Artifacts
        shell: powershell
        run: |
          # 创建打包目录
          New-Item -ItemType Directory -Force -Path "release_output"
          # 复制生成的文件
          Copy-Item -Path "build\windows\runner\Release\*" -Destination "release_output" -Recurse
          
          # 【重要检查】
          # 如果 PiliPlus 的自动脚本下载了错误的 DLL，你可能需要在这里手动下载 ARM64 的 libmpv-2.dll 并覆盖
          # 但在原生环境下，media_kit 有很大通过检测系统架构自动下载正确的文件。

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: PiliPlus-Windows-ARM64-Native
          path: release_output/
