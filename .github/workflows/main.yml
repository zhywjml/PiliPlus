name: Build Windows ARM64

on:
  workflow_dispatch: # 允许你手动点击按钮触发编译

jobs:
  build:
    runs-on: windows-latest # 使用 GitHub 的 Windows 环境（默认是 x64）

    steps:
      - uses: actions/checkout@v4

      - name: Install Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable' # 使用稳定版，避免未知错误

      - name: Enable Desktop Support
        run: |
          flutter config --enable-windows-desktop

      - name: Modify CMake for ARM64 (The Magic Step)
        shell: powershell
        run: |
          # 这是一个 PowerShell 脚本，它会自动把 "set(CMAKE_GENERATOR_PLATFORM "ARM64")" 
          # 插入到 windows/CMakeLists.txt 的正确位置
          $file = "windows/CMakeLists.txt"
          $content = Get-Content $file
          # 在文件开头插入配置
          $newContent = @("set(CMAKE_GENERATOR_PLATFORM ""ARM64"")") + $content
          Set-Content $file $newContent
          Write-Host "CMakeLists.txt modified successfully for ARM64!"

      - name: Get Dependencies
        run: flutter pub get

      - name: Build Windows Release
        run: flutter build windows --release
        # 注意：这里不需要加 --arch 参数，因为我们在上面的步骤里通过修改 CMake 文件强制指定了 ARM64

      - name: Prepare Artifacts
        shell: powershell
        run: |
          # 创建一个发布文件夹
          New-Item -ItemType Directory -Force -Path "release_output"
          # 把编译生成的文件复制出来
          Copy-Item -Path "build\windows\runner\Release\*" -Destination "release_output" -Recurse

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: PiliPlus-Windows-ARM64-Unpackaged
          path: release_output/
